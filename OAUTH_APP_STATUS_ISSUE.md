# OAuth 授权失败诊断报告（权限已确认）

**日期**: 2026-01-18
**状态**: ⚠️ 权限已确认，问题在其他配置

---

## ✅ 已排除的问题

1. ✅ **State 参数格式** - 测试了 6 种格式，全部失败
2. ✅ **API 版本** - 测试了新旧两个版本，全部失败
3. ✅ **URL 编码** - 已修复，所有参数正确编码
4. ✅ **Redirect URI 端口** - 已统一为 3333
5. ✅ **Scope 权限申请** - **已确认所有权限都已申请**

---

## 🔍 新的假设：应用状态或用户权限问题

### 飞书官方文档中的相关错误码

| 错误码 | 描述 | 检查项 |
|-------|------|--------|
| **20069** | 应用未启用 | 应用状态是否为"已启用"？ |
| **20009** | 租户未安装应用 | 应用是否已安装到租户？ |
| **20048** | 应用不存在 | 应用 ID 是否正确？ |
| **20010** | 用户无应用使用权限 | 测试用户是否有权限？ |
| **20066** | 用户状态非法 | 测试用户状态是否正常？ |

---

## 📋 需要飞书后台确认的信息

### 1️⃣ **应用基本信息**

**路径**: 开发者后台 > 应用详情 > 凭证与基础信息

```
应用名称: ___________
App ID: cli_a9e09cc76d345bb4
App 类型: [ ] 自建应用  [ ] 商店应用
应用状态: [ ] 已启用  [ ] 停用  [ ] 未发布
可用范围: [ ] 仅本企业  [ ] 所有企业  [ ] 指定企业
创建时间: ___________
```

### 2️⃣ **应用发布状态**

**自建应用需要**:
- [ ] 应用已启用（不是"停用"状态）
- [ ] 应用已发布/上线
- [ ] 应用已安装到测试租户

**如何检查**:
1. 应用详情页顶部查看状态
2. 如果显示"停用" → 点击"启用"
3. 如果未发布 → 点击"发布"

### 3️⃣ **重定向 URI 配置**

**路径**: 开发者后台 > 应用详情 > 开发配置 > 安全设置

```
已配置的重定向 URL:
[ ] http://localhost:3333/callback
[ ] https://example.com/callback
[ ] 其他: ___________
```

**注意事项**:
- ✅ 必须完全匹配（包括协议、域名、端口、路径）
- ❌ 不要有尾部斜杠: `/callback/` ❌
- ❌ 协议必须正确: `https://localhost:3333/callback` ❌

### 4️⃣ **测试用户权限**

**需要确认**:
```
测试用户的飞书账号: ___________
是否在应用可用企业内: [ ] 是  [ ] 否
是否有应用使用权限: [ ] 是  [ ] 否
用户状态: [ ] 正常  [ ] 停用  [ ] 已删除
```

**错误码 20010**: 用户无应用使用权限

**如何检查**:
1. 确认测试用户的飞书账号在应用可用企业内
2. 确认应用已分配给该用户
3. 确认用户状态正常（未被停用或删除）

---

## 🧪 诊断测试

### 测试 1: 使用飞书官方示例应用

**目的**: 排除代码问题

**步骤**:
1. 访问飞书官方示例应用
2. 使用你的飞书账号登录
3. 观察是否能正常授权

**预期结果**:
- ✅ 如果官方示例能授权 → 你的飞书账号和权限正常
- ❌ 如果官方示例失败 → 问题在飞书账号或应用配置

### 测试 2: 最简化授权 URL（无 scope）

```bash
https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a9e09cc76d345bb4&redirect_uri=http%3A%2F%2Flocalhost%3A3333%2Fcallback&response_type=code
```

**说明**: 不传递 scope 和 state 参数

**预期结果**:
- ✅ 如果成功 → scope 参数有问题
- ❌ 如果失败 → 应用状态/用户权限问题

### 测试 3: 检查应用发布状态

**步骤**:
1. 登录飞书开发者后台
2. 进入应用详情
3. 查看应用状态

**关键检查**:
- [ ] 应用是否"启用"？
- [ ] 应用是否"已发布"？
- [ ] 应用是否"已安装"？

### 测试 4: 使用不同的飞书账号测试

**目的**: 排除用户权限问题

**步骤**:
1. 使用另一个飞书账号（同一企业）
2. 访问授权 URL
3. 观察结果

**预期结果**:
- ✅ 如果其他账号能授权 → 原账号权限问题
- ❌ 如果所有账号都失败 → 应用配置问题

---

## 🔧 可能的解决方案

### 方案 1: 应用未启用

**症状**: 应用详情页显示"停用"或"未发布"

**解决步骤**:
1. 在应用详情页找到"启用"按钮
2. 点击启用应用
3. 等待 1-2 分钟使配置生效
4. 重新测试授权

### 方案 2: 应用未安装到租户

**症状**: 错误码 20009

**解决步骤**:
1. 进入"发布管理"或"可用性管理"
2. 选择"添加到企业"
3. 选择你的企业
4. 确认添加

### 方案 3: 用户无应用使用权限

**症状**: 错误码 20010

**解决步骤**:
1. 确认测试用户在应用可用企业内
2. 联系管理员分配应用权限
3. 或者使用有权限的账号测试

### 方案 4: 重定向 URI 配置错误

**症状**: 错误码 20029（已修复）或 20071

**解决步骤**:
1. 删除现有的重定向 URI
2. 重新添加: `http://localhost:3333/callback`
3. 确保没有尾部斜杠
4. 确保协议是 `http`（不是 `https`）

---

## 📊 飞书后台截图需求

为了更准确地诊断，请提供以下截图：

### 截图 1: 凭证与基础信息页面
- 显示 App ID
- 显示应用状态（启用/停用）
- 显示应用类型

### 截图 2: 权限管理页面
- 显示已申请的用户权限（我们已知）
- 显示权限状态（已开通/待审核/已拒绝）

### 截图 3: 安全设置 - 重定向 URL
- 显示已配置的重定向 URI
- 确认为 `http://localhost:3333/callback`

### 截图 4: 应用发布/可用性管理
- 显示应用发布状态
- 显示可用企业范围

### 截图 5: 错误页面
- 完整的浏览器地址栏 URL
- 错误页面内容
- Log ID（如果有）

---

## 🎯 下一步行动

### 立即执行

1. **检查应用状态** - 是否启用、已发布、已安装
2. **测试简化 URL** - 不带 scope 和 state
3. **提供飞书后台截图** - 帮助定位具体问题

### 如果应用状态正常

1. **检查测试用户权限** - 确认用户能使用应用
2. **使用不同账号测试** - 排除用户问题
3. **联系飞书技术支持** - 提供完整信息和截图

---

## 📞 飞书官方支持

如果以上排查仍无法解决，联系飞书技术支持时请提供：

```
应用信息:
---------
App ID: cli_a9e09cc76d345bb4
App 名称: ___________
App 类型: ___________
应用状态: ___________
已申请权限: (见附图)

错误信息:
---------
错误码: 400
错误描述: state 参数格式错误
出现位置: [打开 URL 时 / 点击授权后]
完整 URL: ___________
Log ID: ___________

测试账号:
---------
测试用户: ___________
用户企业: ___________
用户状态: ___________

已尝试的方案:
-----------
1. ✅ 测试了 6 种 state 格式 - 全部失败
2. ✅ 测试了新旧 API 版本 - 全部失败
3. ✅ 修复了 URL 编码问题 - 仍然失败
4. ✅ 修复了 redirect_uri 端口 - 仍然失败
5. ✅ 确认了所有权限已申请 - 仍然失败
```

---

**更新**: 2026-01-18
**状态**: 等待飞书后台配置信息和截图
**优先级**: 🔥 检查应用状态（启用/发布/安装）
