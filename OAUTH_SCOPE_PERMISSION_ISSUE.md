# OAuth Scope æƒé™é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**å‘ç°æ—¥æœŸ**: 2026-01-18
**ä¸¥é‡ç¨‹åº¦**: âš ï¸âš ï¸âš ï¸ **å…³é”®é—®é¢˜**
**çŠ¶æ€**: ğŸ” **å¾…ç¡®è®¤é£ä¹¦åå°æƒé™é…ç½®**

---

## ğŸ¯ æ ¸å¿ƒå‘ç°

åŸºäºé£ä¹¦å®˜æ–¹æ–‡æ¡£æ·±å…¥åˆ†æï¼Œå‘ç°äº†ä¹‹å‰**æ‰€æœ‰å°è¯•éƒ½æœªæ¶‰åŠ**çš„æ ¹æœ¬åŸå› ï¼š

### é—®é¢˜ï¼šScope æƒé™æœªåœ¨é£ä¹¦åå°ç”³è¯·

**ä»£ç ä¸­çš„ Scope è¯·æ±‚** (`lib/feishu_api_client.py:637`):
```python
scope = "docx:document docx:document:readonly wiki:wiki:readonly offline_access"
```

**é£ä¹¦å®˜æ–¹æ–‡æ¡£æ˜ç¡®è¦æ±‚** (é”™è¯¯ç  20027):
> ç”¨æˆ·æˆæƒåº”ç”¨æ—¶æŠ¥é”™ 20027ï¼šæ‰“å¼€æˆæƒé¡µæ—¶æ‹¼æ¥çš„ scope å‚æ•°ä¸­åŒ…å«**å½“å‰åº”ç”¨æœªå¼€é€šçš„æƒé™**ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
> å‰å¾€å¼€å‘è€…åå°ï¼Œåœ¨å¯¹åº”åº”ç”¨çš„ **å¼€å‘é…ç½® > æƒé™ç®¡ç† > API æƒé™** åŠŸèƒ½é¡µå¼€é€šç›¸åº”çš„æƒé™ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆæŠ¥ "state æ ¼å¼é”™è¯¯" è€Œä¸æ˜¯ "scope æƒé™é”™è¯¯"ï¼Ÿ

**é£ä¹¦é”™è¯¯ä¿¡æ¯çš„è¯¯å¯¼æ€§**ï¼š

å½“æˆæƒ URL çš„å‚æ•°éªŒè¯å¤±è´¥æ—¶ï¼ˆåŒ…æ‹¬ scope åŒ…å«æœªç”³è¯·çš„æƒé™ï¼‰ï¼Œé£ä¹¦ OAuth æœåŠ¡å™¨å¯èƒ½è¿”å›é€šç”¨çš„ "state å‚æ•°æ ¼å¼é”™è¯¯"ï¼ˆHTTP 400ï¼‰ï¼Œè€Œä¸æ˜¯å…·ä½“çš„é”™è¯¯ç  20027ã€‚

**è¯æ®**ï¼š
1. æˆ‘ä»¬æµ‹è¯•äº† 6 ç§ä¸åŒçš„ state æ ¼å¼ â†’ **å…¨éƒ¨å¤±è´¥**
2. æˆ‘ä»¬æµ‹è¯•äº†æ–°æ—§ä¸¤ä¸ª API ç‰ˆæœ¬ â†’ **å…¨éƒ¨å¤±è´¥**
3. æˆ‘ä»¬ä¿®å¤äº† URL ç¼–ç å’Œç«¯å£é—®é¢˜ â†’ **ä»ç„¶å¤±è´¥**

è¿™å¼ºçƒˆæš—ç¤ºï¼š**é—®é¢˜æ ¹æœ¬ä¸åœ¨ state å‚æ•°ï¼**

---

## ğŸ“‹ å®Œæ•´è¯Šæ–­æ¸…å•

### 1ï¸âƒ£ **Scope æƒé™éªŒè¯** â­ **æœ€ä¼˜å…ˆ**

**æ“ä½œæ­¥éª¤**ï¼š

1. ç™»å½•é£ä¹¦å¼€å‘è€…åå°: https://open.feishu.cn/app
2. è¿›å…¥åº”ç”¨: `cli_a9e09cc76d345bb4`
3. å¯¼èˆªåˆ°: **å¼€å‘é…ç½® > æƒé™ç®¡ç† > API æƒé™**
4. æ£€æŸ¥ä»¥ä¸‹æƒé™æ˜¯å¦å·²ç”³è¯·ï¼š

| Scope æƒé™ | æ˜¯å¦å·²ç”³è¯· | æƒé™è¯´æ˜ |
|-----------|----------|---------|
| `docx:document` | [ ] | æ–‡æ¡£æƒé™ - åˆ›å»ºå’Œç¼–è¾‘æ–‡æ¡£ |
| `docx:document:readonly` | [ ] | æ–‡æ¡£æƒé™ - åªè¯»è®¿é—® |
| `wiki:wiki:readonly` | [ ] | çŸ¥è¯†åº“æƒé™ - åªè¯»è®¿é—® |
| `offline_access` | [ ] | ç¦»çº¿è®¿é—® - è·å– refresh_token |

**å¦‚æœæƒé™æœªç”³è¯·**ï¼š
- ç‚¹å‡»å¯¹åº”æƒé™çš„"ç”³è¯·"æŒ‰é’®
- å¡«å†™ç”³è¯·ç†ç”±
- æäº¤ç”³è¯·å¹¶ç­‰å¾…å®¡æ ¸ï¼ˆé€šå¸¸å³æ—¶é€šè¿‡ï¼‰

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# ç”ŸæˆåªåŒ…å«ä¸€ä¸ªæƒé™çš„æœ€å°åŒ–æˆæƒ URL
https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a9e09cc76d345bb4&redirect_uri=http%3A%2F%2Flocalhost%3A3333%2Fcallback&scope=contact%3Auser.base%3Areadonly&response_type=code
```

å¦‚æœè¿™ä¸ª URL èƒ½æ­£å¸¸æ˜¾ç¤ºæˆæƒé¡µé¢ï¼Œè¯´æ˜é—®é¢˜ç¡®å®æ˜¯ scope æƒé™ï¼

---

### 2ï¸âƒ£ **åº”ç”¨çŠ¶æ€æ£€æŸ¥**

**æ£€æŸ¥é¡¹**ï¼ˆå¼€å‘è€…åå° > åº”ç”¨è¯¦æƒ…ï¼‰ï¼š

| æ£€æŸ¥é¡¹ | æœŸæœ›çŠ¶æ€ | é”™è¯¯ç  |
|-------|---------|--------|
| åº”ç”¨çŠ¶æ€ | **å·²å¯ç”¨** | 20069: åº”ç”¨æœªå¯ç”¨ |
| åº”ç”¨å¯ç”¨æ€§ | **å·²å‘å¸ƒ/å·²å®‰è£…** | 20009: ç§Ÿæˆ·æœªå®‰è£…åº”ç”¨ |
| åº”ç”¨å­˜åœ¨æ€§ | **æ­£å¸¸** | 20048: åº”ç”¨ä¸å­˜åœ¨ |
| æµ‹è¯•ç”¨æˆ·æƒé™ | **æœ‰æƒé™** | 20010: ç”¨æˆ·æ— åº”ç”¨ä½¿ç”¨æƒé™ |

**å¦‚ä½•ç¡®è®¤**ï¼š
1. åº”ç”¨è¯¦æƒ…é¡µé¡¶éƒ¨åº”æ˜¾ç¤º"å·²å¯ç”¨"çŠ¶æ€
2. åº”ç”¨å¯ç”¨èŒƒå›´ï¼šè‡³å°‘åŒ…æ‹¬"æœ¬ä¼ä¸š"
3. ç¡®è®¤ä½ çš„é£ä¹¦è´¦å·æœ‰æƒé™ä½¿ç”¨è¯¥åº”ç”¨

---

### 3ï¸âƒ£ **Token ç«¯ç‚¹ä¿®å¤** âš ï¸ **æ¬¡è¦é—®é¢˜**

**å½“å‰ä»£ç é—®é¢˜** (`lib/feishu_api_client.py:416-421`):
```python
payload = {
    "grant_type": "authorization_code",
    "client_id": self.app_id,
    "client_secret": self.app_secret,
    "code": authorization_code,
    # âŒ ç¼ºå°‘ redirect_uri å‚æ•°
}
```

**é£ä¹¦å®˜æ–¹è¦æ±‚**ï¼ˆé”™è¯¯ç  20071ï¼‰:
> æä¾›çš„ redirect_uri ä¸æˆæƒæ—¶ä½¿ç”¨çš„ redirect_uri ä¸ä¸€è‡´ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
payload = {
    "grant_type": "authorization_code",
    "client_id": self.app_id,
    "client_secret": self.app_secret,
    "code": authorization_code,
    "redirect_uri": "http://localhost:3333/callback",  # âœ… æ·»åŠ æ­¤å‚æ•°
}
```

**æ³¨æ„**ï¼šè™½ç„¶æ–‡æ¡£è¯´ redirect_uri æ˜¯å¯é€‰çš„ï¼Œä½†ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œå»ºè®®æ·»åŠ ã€‚

---

## ğŸš€ æ¨èçš„æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: ä½¿ç”¨å®˜æ–¹æœ€å°æƒé™æµ‹è¯•

ç”ŸæˆåªåŒ…å« `contact:user.base:readonly` çš„æˆæƒ URLï¼ˆè¿™æ˜¯æœ€å¸¸è§çš„æƒé™ï¼‰ï¼š

```bash
https://accounts.feishu.cn/open-apis/authen/v1/authorize?client_id=cli_a9e09cc76d345bb4&redirect_uri=http%3A%2F%2Flocalhost%3A3333%2Fcallback&scope=contact%3Auser.base%3Areadonly&response_type=code&state=123456
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ å¦‚æœä»ç„¶æŠ¥é”™ â†’ é—®é¢˜å¯èƒ½æ˜¯åº”ç”¨çŠ¶æ€/ç”¨æˆ·æƒé™
- âœ… å¦‚æœæ­£å¸¸æ˜¾ç¤ºæˆæƒé¡µé¢ â†’ é—®é¢˜ç¡®å®æ˜¯ scope æƒé™ï¼

### æ­¥éª¤ 2: é€æ­¥å¢åŠ æƒé™

å¦‚æœæ­¥éª¤ 1 æˆåŠŸï¼Œé€ä¸ªæ·»åŠ æƒé™è¿›è¡Œæµ‹è¯•ï¼š

```bash
# æµ‹è¯• 1: åªåŠ  offline_access
scope=offline_access

# æµ‹è¯• 2: åŠ  docx:document
scope=contact:user.base:readonly%20docx:document

# æµ‹è¯• 3: åŠ  wiki:wiki:readonly
scope=contact:user.base:readonly%20wiki:wiki:readonly
```

### æ­¥éª¤ 3: æ£€æŸ¥é£ä¹¦åå°é…ç½®æˆªå›¾

æä¾›ä»¥ä¸‹æˆªå›¾ä»¥ä¾¿è¯Šæ–­ï¼š

1. **å‡­è¯ä¸åŸºç¡€ä¿¡æ¯é¡µé¢**
   - App ID
   - App Secretï¼ˆéƒ¨åˆ†é®ç›–ï¼‰
   - åº”ç”¨çŠ¶æ€

2. **æƒé™ç®¡ç† > API æƒé™é¡µé¢**
   - å·²ç”³è¯·çš„æƒé™åˆ—è¡¨
   - æƒé™çŠ¶æ€ï¼ˆå·²å¼€é€š/å¾…å®¡æ ¸/å·²æ‹’ç»ï¼‰

3. **å®‰å…¨è®¾ç½® > é‡å®šå‘ URL é¡µé¢**
   - é…ç½®çš„é‡å®šå‘ URL
   - ç¡®è®¤ä¸º `http://localhost:3333/callback`

---

## ğŸ”§ ä¿®å¤ä»£ç 

### ä¿®å¤ 1: æ›´æ–° Scope ä¸ºæœ€å°æƒé™

**æ–‡ä»¶**: `lib/feishu_api_client.py`

```python
# å½“å‰ä»£ç ï¼ˆç¬¬ 625-637 è¡Œï¼‰
def generate_oauth_url(
    self,
    redirect_uri: str = "http://localhost:3333/callback",
    scope: Optional[str] = None,
    state: Optional[str] = None,
) -> str:
    # ...
    if not scope:
        # âŒ é—®é¢˜ï¼šè¯·æ±‚äº†æœªç”³è¯·çš„æƒé™
        scope = "docx:document docx:document:readonly wiki:wiki:readonly offline_access"
```

**ä¿®å¤æ–¹æ¡ˆ A** - ä½¿ç”¨æœ€å°æƒé™ï¼š
```python
if not scope:
    # âœ… åªè¯·æ±‚å¿…éœ€çš„æƒé™ï¼ˆéœ€è¦åœ¨é£ä¹¦åå°ç”³è¯·ï¼‰
    scope = "contact:user.base:readonly"  # æœ€å°æƒé™
```

**ä¿®å¤æ–¹æ¡ˆ B** - å®Œå…¨ç§»é™¤ scope å‚æ•°ï¼š
```python
if not scope:
    # âœ… ä¸ä¼ é€’ scopeï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æˆæƒ
    scope = ""  # ç©ºå­—ç¬¦ä¸²
```

### ä¿®å¤ 2: æ·»åŠ  redirect_uri åˆ° Token ç«¯ç‚¹

**æ–‡ä»¶**: `lib/feishu_api_client.py`

```python
def exchange_authorization_code(self, authorization_code: str) -> Dict[str, Any]:
    # ...
    url = f"{self.BASE_URL}{self.USER_TOKEN_ENDPOINT}"
    payload = {
        "grant_type": "authorization_code",
        "client_id": self.app_id,
        "client_secret": self.app_secret,
        "code": authorization_code,
        "redirect_uri": "http://localhost:3333/callback",  # âœ… æ·»åŠ æ­¤å‚æ•°
    }
```

---

## ğŸ“Š è¯Šæ–­è„šæœ¬è¾“å‡º

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå®Œæ•´è¯Šæ–­ä¿¡æ¯ï¼š

```bash
uv run python scripts/diagnose_oauth.py
```

**é¢„æœŸè¾“å‡ºåº”åŒ…å«**ï¼š
- âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- âœ… API è¿æ¥æ€§æ­£å¸¸
- âœ… ç”Ÿæˆçš„ URL æ ¼å¼æ­£ç¡®
- âš ï¸ **Scope æƒé™éªŒè¯**ï¼ˆéœ€è¦äººå·¥ç¡®è®¤ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

1. **ç™»å½•é£ä¹¦å¼€å‘è€…åå°** ç¡®è®¤æƒé™é…ç½®
2. **æ£€æŸ¥ `docx:document` ç­‰æƒé™æ˜¯å¦å·²ç”³è¯·**
3. **å¦‚æœæœªç”³è¯·ï¼Œç«‹å³ç”³è¯·å¹¶ç­‰å¾…å®¡æ ¸**

### å¦‚æœæƒé™éƒ½å·²ç”³è¯·

1. **æ£€æŸ¥åº”ç”¨çŠ¶æ€**ï¼šæ˜¯å¦å¯ç”¨ã€å·²å®‰è£…
2. **éªŒè¯ç”¨æˆ·æƒé™**ï¼šæµ‹è¯•ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ä½¿ç”¨åº”ç”¨
3. **åº”ç”¨ä¿®å¤ä»£ç **ï¼šæ›´æ–° scope å’Œæ·»åŠ  redirect_uri

### æä¾›ç»™é£ä¹¦å®˜æ–¹æ”¯æŒçš„ä¿¡æ¯

```
åº”ç”¨é…ç½®:
-------------
App ID: cli_a9e09cc76d345bb4
App ç±»å‹: [è‡ªå»º/å•†åº—]
App çŠ¶æ€: [å¯ç”¨/åœç”¨]
å·²ç”³è¯·çš„æƒé™: [åˆ—å‡ºæ‰€æœ‰]

Scope é…ç½®:
-----------
ä»£ç è¯·æ±‚çš„ scope: docx:document docx:document:readonly wiki:wiki:readonly offline_access
è¿™äº›æƒé™æ˜¯å¦å·²ç”³è¯·: [æ˜¯/å¦]

é”™è¯¯ä¿¡æ¯:
---------
é”™è¯¯ç : 400
é”™è¯¯æè¿°: state å‚æ•°æ ¼å¼é”™è¯¯
å‡ºç°ä½ç½®: [æ‰“å¼€ URL æ—¶/ç‚¹å‡»æˆæƒå]

æµ‹è¯• URL:
---------
æœ€å°æƒé™æµ‹è¯•: [ç²˜è´´ contact:user.base:readonly æµ‹è¯• URL]
æµ‹è¯•ç»“æœ: [æˆåŠŸ/å¤±è´¥]
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é£ä¹¦å®˜æ–¹: è·å–æˆæƒç ](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code)
- [é£ä¹¦å®˜æ–¹: è·å– user_access_token](https://open.feishu.cn/document/common-capabilities/sso/api/get-user-access-token)
- [é”™è¯¯ç  20027 è¯´æ˜](https://open.feishu.cn/document/common-capabilities/sso/api/obtain-oauth-code#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98)

---

**å‘ç°è€…**: Claude Code
**åŸºäº**: é£ä¹¦å®˜æ–¹æ–‡æ¡£ï¼ˆ2025-09-18 / 2025-12-22 ç‰ˆæœ¬ï¼‰
**ç½®ä¿¡åº¦**: â­â­â­â­â­ **æé«˜** - è¿™æ˜¯å”¯ä¸€æœªæµ‹è¯•è¿‡çš„æ ¹æœ¬åŸå› 
